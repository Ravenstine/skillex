#!/usr/bin/env node

'use strict';

const fs         = require('fs');
const browserify = require('browserify');
const through2   = require("through2");
const Uglify     = require('uglify-es');


let pillBox = require('../lib/pill-box')('./pills');

let pills   = JSON.stringify(pillBox); 

let output = `'use strict';\n\nconst pills = ${pills};\n\n`;

let browserifyOptions = {
  standalone:       'lambda',
  browserField:     false,
  builtins:         false,
  commondir:        false,
  ignoreMissing:    true,  // Do not fail on missing optional dependencies
  detectGlobals:    true,  // Default for bare in cli is true, but we don't care if its slower
  insertGlobalVars: {      // Handle process https://github.com/substack/node-browserify/issues/1277
    process: function() {}
  }  
};

let uglifyOptions = {
  mangle:   false, //@see http://lisperator.net/uglifyjs/compress
  ecma: 6
};

let bundle = browserify(browserifyOptions);

bundle.add('./lib/bundle-blueprint.js', {noParse: ['aws-sdk']});
bundle.bundle()
  .pipe(through2(function (chunk, enc, callback) {
    output += chunk;
    callback()
  }))
  .on('finish', function () {
    // output = JSON.stringify(Uglify.minify(output, uglifyOptions));
    fs.writeFileSync(`build/index.js`, output);
  })


